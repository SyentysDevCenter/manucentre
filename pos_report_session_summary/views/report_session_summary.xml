<?xml version="1.0" encoding="utf-8"?>
<odoo>
<template id="report_session_summary">
    <t t-call="web.html_container">
        <t t-foreach="docs" t-as="o">
            <t t-call="web.basic_layout">
                <div class="page">
                    <h2>Résumé de la session :<span t-field="o.name"/></h2>

                    <div class="row mt32 mb32">
                        <div class="col-auto mw-100 mb-3">
                            <strong>Responsable</strong>:<br/>
                            <span t-field="o.user_id"/>
                        </div>
                        <div class="col-auto mw-100 mb-3">
                            <strong>Point de vente</strong>:<br/>
                            <span t-field="o.config_id"/>
                        </div>
                        <div class="col-auto mw-100 mb-3">
                            <strong>Date d'ouverture</strong>:<br/>
                            <span t-field="o.start_at"/>
                        </div>
                        <div class="col-auto mw-100 mb-3">
                            <strong>Date de clôture</strong>:<br/>
                            <span t-field="o.stop_at"/>
                        </div>
                    </div>

                    <h4>Résumé du relevé</h4>

                    <table class="table table-sm o_main_table">
                        <thead>
                            <tr>
                                <th>
                                    <strong>Pos Pyament</strong>
                                </th>
                                <th>
                                    <strong>Montant</strong>
                                </th>
                                <th class="text-right">
                                    <strong>Type</strong>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr t-foreach="o.pos_payment_by_method_ids" t-as="payment">
                                <td><span t-field="payment.pos_payment_id"/></td>
                                <td><span t-field="payment.amount"/></td>
                                <td class="text-right"><span t-field="payment.type"/></td>
                            </tr>
                        </tbody>
                    </table>

                    <div>
                        <t t-set="orders" t-value="o.order_ids"/>
                        <t t-set="bo" t-value="o.account_payment_ids"/>
                        <t t-set="o_amount_total" t-value="sum(o.amount_total for o in orders)"/>
                        <t t-set="o_amount_tax_total" t-value="sum(o.amount_tax for o in orders)"/>
                        <t t-set="bo_amount_total" t-value="sum(o.amount for o in bo)"/>

                        <!-- TBD add bo -->

                        <t t-set="bo_amount_tax_total" t-value="0"/>

                        <strong>Chiffre d'affaire ttc</strong>: <t t-esc="o_amount_total + bo_amount_total"/><br/>
                        <strong>Chiffre d'affaire HT</strong>: <t t-esc="o_amount_total + bo_amount_total - o_amount_tax_total - bo_amount_tax_total"/><br/>
                        <strong>TVA</strong>: <t t-esc="o_amount_tax_total + bo_amount_tax_total"/><br/>
                        <t t-set="move_lines" t-value="o._get_related_account_moves().mapped('line_ids')"/>
                        <t t-foreach="move_lines" t-as="line">
                            <tr  t-if="line.tax_line_id">
                                <td><strong t-field="line.name"/>: </td>
                                <td><span t-field="line.credit"/></td><br/>
                            </tr>
                        </t>
                    </div>

                    <!-- pos orders group by payment method -->
                    <t t-set="payment_method" t-value="[]"/>
                    <t t-foreach="o.order_ids.mapped('payment_ids')" t-as="p">
                        <t t-set="payment_method" t-value="payment_method+[p.payment_method_id.name]"/>
                    </t>

                    <t t-foreach="set(payment_method)" t-as="payment_method_group">
                        <p style="page-break-after:always;"/>
                        <h4>Détails du Relevé : <span t-esc="payment_method_group"/></h4>

                        <table class="table table-sm o_main_table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Transaction</th>
                                    <th>Session</th>
                                    <th>Client</th>
                                    <th>Vendeur</th>
                                    <th class="text-right">Montant</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="o.order_ids.mapped('payment_ids')" t-as="p">
                                    <tr  t-if="payment_method_group==p.payment_method_id.name">
                                        <td><span t-field="p.pos_order_id.date_order"/></td>
                                        <td><span t-field="p.transaction_id"/></td>
                                        <td><span t-field="p.session_id"/></td>
                                        <td><span t-field="p.pos_order_id.partner_id"/></td>
                                        <td><span t-field="p.pos_order_id.user_id"/></td>
                                        <td class="text-right"><span t-field="p.amount"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </t>

                    <!-- bo -->
                    <t t-set="bo" t-value="o.account_payment_ids">
                        <p style="page-break-after:always;"/>
                        <h4 t-if="bo">Détails du Relevé : <span t-esc="bo"/></h4>

                            <table class="table table-sm o_main_table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Transaction</th>
                                        <th>Session</th>
                                        <th>Client</th>
                                        <th>Vendeur</th>
                                        <th class="text-right">Montant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr  t-foreach="bo" t-as="b">
                                        <td><span t-field="b.invoice_date"/></td>
                                        <td><span t-field="b.journal_id"/></td>
                                        <td><span t-field="o.journal_id"/></td>
                                        <td><span t-field="b.partner_id.name"/></td>
                                        <td><span t-field="b.invoice_user_id"/></td>
                                        <td class="text-right"><span t-field="b.amount_total"/></td>
                                    </tr>
                                </tbody>
                            </table>
                    </t>
                </div>
            </t>
        </t>
    </t>
</template>
</odoo>
